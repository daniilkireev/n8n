# ГЛОБАЛЬНОЕ ПРАВИЛО ЭТОГО ДОКУМЕНТА:
- БЕЗ КОНКРЕТНОГО УКАЗАНИЯ НА FEATURE К РАЗРАБОТКЕ - НИЧЕГО ДЕЛАТЬ НЕ НАДО!!!
- Если тебе ссылаются на этот файл в качестве ТЗ и не указывают конкретную feature к разработке - то без конкретного указания на конкретный раздел с именем Feature ничего разрабатывать НЕ НУЖНО! Запроси конкретные указания на имя Feature которую необходимо сейчас разработать.
- Если задание подразумевает только исследование, анализ или ПЛАНИРОВАНИЕ, то НЕ НУЖНО ничего разрабатывать! Необходимо провести только исследование, анализ или планирование.
- Текст этого файла возьми как основу и документацию для понимания бизнес сути проекта.
- Документ дополняется накопительным итогом - вверху самые старые разделы, внизу самые новые спецификации. Если какая-то спецификация ранних этапов входит в противоречение с реализованной спецификацией на более поздних этапах, то актуальной истиной является самая поздняя реализация.
- Учти все разделы всех фич описывающие логику работы, требования, техническую реализацию, ожидаемый результат и итоги реализации. Все требования должны учитываться накопительным итогом в реализации feature даже если они не указываются в тексте описания feature в явном виде.

## КОНТЕКСТ:
- В этой папке новый MVP проект n8n. Суть проекта - сделать минимальный n8n для интеграции с платформой чат-ботов Salebot.pro, сервисами Google (Google Sheets) и другими.
- Используются ДВА инстанса n8n: облачный cloud и локальный self-hosted.
- Все Workflow должны поддерживать одинаковую работу с cloud и self-hosted.

# ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ MVP:
- Указанные версии ПО - актуальные на текущий момент (Октябрь 2025). Разрешается использовать более новые стабильные версии ПО.
- Стек и версии указаны для локальной версии инстанса n8n.

## Стек и версии (self-hosted n8n)
- **n8n**: Self-hosted установка последней версии 1.118.2.
- **Python**: 3.13.14 и новее (обязательно использование `venv`).

## Сетевые настройки (self-hosted n8n)
- **Туннель для HTTPS**: Для внешних интеграций и webhook сервис доступен через отдельную VPS n8n.autsorsim.ru.
- **Доступ извне**: PROD - свободный доступ с самого хоста, а также из локальной сети. DEV - с любого компьютера.
- **Безопасность**: Для безопасного внешнего доступа — ограничивать фаерволом системы или туннелировать через SSH. Не настраивать повышенную безопасность в Docker/Compose.
- **URL локального n8n**: Собственный сервер n8n установлен и доступен по URL: http://192.168.1.60:5678/home/workflows.

## Контейнеризация (Docker/Compose) (self-hosted n8n)
- **Базовый образ**: оригинальный официальный n8n `docker.n8n.io/n8nio/n8n`.

## База данных и хранение состояния (при необходимости) (self-hosted n8n)
- **СУБД**: PostgreSQL 16, оригинальный официальный образ.

## Ограничения MVP
- Нет мониторингов/дашбордов/метрик активности поверх логов.
- Нет сложной ротации логов (только суточные файлы + простая очистка по 14 дням).
- Минимум абстракций, максимум простоты и надёжности.

## Безопасность
- **Токен API**: Все запросы к единому endpoint для внешних запросов /router/ должны иметь токен в header для post или ?x-api-key параметр для get равным значению из %env%.

# ОБЩИЕ ТРЕБОВАНИЯ К WORKFLOW
- Всегда используем уже существующие в n8n credentials (подставляем их в workflow).
- В каждой workflow должен быть Edit Fields (Set) node с именем `Config` для настроек необходимых для работы этого workflow (название `Config` одинаково во всех workflow).
- Текущие production workflow находятся в папке /n8n.prod.workflow/.
- Новые разрабатываемые dev/test workflow должны находиться в папке /n8n.dev.workflow/ с именем где перед ".json" идет дата и время, например: "payment.single.20251128.1331.json" (json создан 28.11.2025 в 13:31).
- Базовый URL для production WebHook: https://n8n.autsorsim.ru/webhook/
- Всегда возвращаем результат через ноду Respond to Webhook.
- САМАЯ БОЛЬШАЯ КАТАСТРОФА - ЭТО ДВОЙНОЕ ПЕРЕЧИСЛЕНИЕ СРЕДСТВ!!! ПРИ СОВЕРШЕНИИ ОПЕРАЦИЙ ПЕРЕЧИСЛЕНИЙ - ПРИ ВОЗНИКНОВЕНИИ ЛЮБОЙ ОШИБКИ ОСТАНАВЛИВАЕМ ВЕСЬ ПРОЦЕСС!!! (все ошибки обрабатываются вручную оператором и платеж не должен попадать в повторное перечисление без яного исправления ошибки)
- Максимум функциональности делай в нодах типа Code с использованием JavaScript. Старайся добавлять минимум  ветвлений и нод других типов, если их можно заменить нодой типа 'Code' с JavaScript!
- При работе с Google Sheets:
  - В описаниях или примерах CSV дата может быть указана "1-нояб." - это только формат отображения для CSV! В реальном документе это ВСЕГДА обычная дата в формате даты Sheets!
  - Для обновления данных на листе делай точечные изменения данных в конкретных столбцах/ячейках, а не всей строки сразу. Мне НЕ НУЖНО иметь гарантию целостности строки. Мне нужно видеть чистую историю обновлений в GUI для каждой ячейки таблицы в отдельности.
    * Название листа с которым работаем определяем всегда одинаковым образом в коде, не нужно это делать в настройках `Config`.
    * Если для workflow входящим параметром не задана конкретная дата для работы, то при определении названия рабочего листа данных делаем fallback подразумевая текущую дату и соответствующий текущий месяц. Например: если для workflow дата не задана как входящий параметр и сегодня "22.11.2025" - то работаем с листом "нояб_25".







## ШАБЛОН ОФОРМЛЕНИЯ ФИЧИ

```markdown
# %DATE% - ФИЧА: %FEATURE NAME%.

## Бизнес потребность:
- Описываем контекст и профит.

## Исходные данные:
- Таблицы, код и т.п.

## ЗАДАЧА:
- Формулируем задачу.

## Ожидаемый результат:
- Описываем что ожидаем на выходе.

## Итог реализации:
(раздел заполняется уже после реализации фичи на финальной стадии - в качестве документации накопительным итогом)
```



# 11.11.2025 - ФИЧА: Сокращение запросов к Google Sheets с помощью кэшинования справочных данных локально.

## Бизнес потребность:
Я использую google sheet как первоисточник данных, которые меняются довольно редко. Поэтому, для того чтобы при каждом запуске workflow не обращаться к ним напрямую, я хочу сначала скачать их себе в кэш, например, в data table таблицу и в workflow использовать уже данные из data table.

## ЗАДАЧА:
- Проанализируй возможные варианты решения, предложи лучшую архитектуру.
- Это MVP проект, поэтому все должно быть максимально просто и эффективно.
- Напиши такой workflow, который будет получать через сервисную учетную запись google содержимое листа google sheet, будет сохранять его 1 к 1 в таблицу data table.
- Запуск workflow нужно делать каждые 15 минут, либо вручную, либо при запуске через webhook /router?method=cache.update.
- webhook router уже существует, он является единой точкой endpoint для всех внешних запросов. После получения запроса он переадресует этот запрос 1:1 как body запроса в другие дочерние subworkflow со своими webhook и обратно после выполнения дочерних воркфлоу, он передает получившийся ответ json обратно вызывающей стороне. Поэтому в этом workflow должен быть webhook с url вида /cache/update для метода get. Плюс в get должен также передаваться в виде параметра токен доступа как ?x-api-key=LKSJDFIUYKJ (ключ апи).

## Ожидаемый результат:
- Workflow с оптимальной архитектурой, сохраняющий данные первоисточника google sheet локально в n8n в виде кэша. Работа с данными из кэш из других workflow.

## Итог реализации:
(раздел должен заполняться уже по итогам фактической реализации - в качестве документации накопительным итогом)






# ФИЧА 18.11.2025 - Вставка данных исполнителя в табель

## Контекст
Мне необходимо сохранять данные об исполнителе из чат-бот-платформы SaleBot.pro в Google Sheets через Workflow в N8n.

мне необходимо написать такой workflow который будет делать следующую логику один по входящему запросу из salebot он принимает json структуры которые описаны ниже в этом джейсоне находятся данные о авито-объявлении на которое откликнулся человек а также метки из crm системы часть из которых соответствует проектам на который откликнулся этот исполнитель таким образом во входящем json у нас будет avito_order_id как идентификатор того объявления а значит и проекта на которой откликнулся исполнитель и массив меток labels среди которых есть метки с шаблоном "1: %название_проекта%", т.е. шаблон начинается как цифра "1" затем двоеточие и  пробел ": " и далее название проекта на который откликается этот исполнитель.

Эти данные нам необходимо далее искать в Google таблице на листе справочники. Найти по названию одного или нескольких полученных из JSON названий проектов. Найти соответствующие этим проектам идентификаторы Google Sheet таблицы в столбце `Табель`. Структура листа "Справочники" ниже.

После того, как мы получили идентификатор Google Таблицы, мы должны добавить новую запись об исполнителе в файл табель этого проекта (образец структуры табеля ниже). Мы добавим исполнителя в пустую строчку. При этом мы добавляем исполнителя если такого еще в этом файле нет. Соответствие и проверку исполнителей делаем по client_id. Если такой client_id уже нет в файле есть то обновляем данные. Если такого client_id еще в файле нет то добавляем новую строку.


И после этой строки мы должны оставлять пустую строку, которая нужна как разделитель, а также для других данных с другим функционалом. Т.е. каждая запись об исполнителе - это ДВЕ строки. Одна с данными исполнителя, вторая с доп. данными.

Пуструю строку мы определяем как пустое значение в ячейке "ФИО", т.е. проверяя сверху вниз мы смотрим первое место где ФИО пусто, отступаем одну строку ниже (т.к. нам всегда нужно оставлять после ФИО одну строку для доп данных) и вставляем новые данные в это место.

Если такой исполнитель уже есть в файле, то работаем с той строчкой, где уже есть client_id.

## Соответствие данных json и столбцам в google sheet (т.е. вставляем только эти данные!):
- № пропускаем
- Статаус пропускаем
- ФИО > full_name
- Телефон / карта > phone
- client_id / comments > client_id
- Паспорт / ИНН > пропускаем
- tags > labels (но очищенный, без id и просто в строку через запятую, пример: "1: Симпл Внуково, 2: 25-44, 2: Муж, 3: Паспорт, 4: Узбек, 5: 5-2")

## Исходные данные:

### Входящий JSON в n8n из salebot.pro:

{
    "method": "worker.gs.add",
    "client_id": "833573536",
    "full_name": "Пупкин Василий Васильевич",
    "phone": "79957804464",
    "order_id": "833573536-582942145",
    "client_type": "5",
    "group_id": "12334",
    "platform_id": "test_client_online",
    "avito_order_id": "7738113964",
    "avito_order_price": "30004000",
    "avito_order_title": "Грузчик ПРОД склад ЕЖЕДНЕВНО оплата",
    "avito_order_url": "https://avito.ru/1234567",
    "avito_profile": "https://avito.ru/user/dsu123",
    "labels": {
        "1809159": "1: Симпл Внуково",
        "1389135": "2: 25-44",
        "1090393": "2: Муж",
        "1037219": "3: Паспорт",
        "1082258": "4: Узбек",
        "1056095": "5: 5-2"
    },
    "lists": {
        "1056102": "Апрелевка",
        "1815825": "Кокошкино"
    }
}

### Таблица Google Sheet 1yYSPC2JVTV5a6Byoz8lO4GsrD-Nk6i8PCF68hn_7f4I (файл `Объявления`, лист `Справочники`:
Проекты,,Табель,,Специализация,,Тип объекта,,Частота сверок и оплат,,Время заведения на объект - День,,Время заведения на объект - Ночь,,Гражданство,,Города
_ПРОД Склад,,,,_Любая специализация,,_Шаблон,,"Сверка 1 раз в месяц, оплата 1 раз в месяц",,В тот же день (любой день),,В тот же вечер (любой день),,ЕАЭС,,Апрелевка


### Таблица Google Sheet 1yYSPC2JVTV5a6Byoz8lO4GsrD-Nk6i8PCF68hn_7f4I (файл `Объявления`, лист `Avito`:
AvitoID,Проект,Специализация,Статус,Адрес,Комментарий
7738426189,Бау,Разнорабочий,Активно,"Московская обл., г.о. Подольск, д. Макарово, Луговая ул., 26Г",

### Шаблоны соответствия листа в табеле от текущего месяца (код из php):
        1 => 'янв', 2 => 'фев', 3 => 'мар', 4 => 'апр', 5 => 'май', 6 => 'июнь',
        7 => 'июль',8 => 'авг', 9 => 'сен',10 => 'окт',11 => 'нояб',12 => 'дек'

### Таблица табеля с исполнителями (ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets!):
№,Статус,ФИО,Телефон / карта,client_id / comments,Паспорт / ИНН,tags,Нач / обед,Окон,Пер,Часов / Ставка,1-нояб.,2-нояб.,3-нояб.,4-нояб.,5-нояб.,6-нояб.,7-нояб.,8-нояб.,9-нояб.,10-нояб.,11-нояб.,12-нояб.,13-нояб.,14-нояб.,15-нояб.,16-нояб.,17-нояб.,18-нояб.,19-нояб.,20-нояб.,21-нояб.,22-нояб.,23-нояб.,24-нояб.,25-нояб.,26-нояб.,27-нояб.,28-нояб.,29-нояб.,30-нояб.,1-дек.,2-дек.,3-дек.,4-дек.,5-дек.,6-дек.,7-дек.,Расчет,Отраб. час / выпл. аванс,ИТОГО к оплате,Деп накоп прош мес дата / руб,Депозит тек мес дата / руб,Деп списан тек мес дата / руб,Деп выпл тек мес дата / руб,"ВнеРеализ, руб",,Комментарий
1,д,Трубский Егор,+7 958 636-46-50,818255659,,21,08:00,17:00,0,9,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,Д1,В*,В*,В*,В*,В*,В*,Д*,,,,,,,,,,,,,,,,0 ,ВтПт,22-июл.,,,,,,
1,,,Тбанк,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,4 000 р.,,,,0 р.,,

## Задача:
- Реализовать такой workflow для n8n. Использовать MCP.
- Помнить, что это MVP и решение должно быть простым и эффективным.








# 20.11.2025 - ФИЧА: Поиск свободного места в табеле и вставка данных.

## Исходные данные:
- Есть табель выхода исполнителей на работу и перечисления им средств "Бау - Табель" (структура выгруженная в виде CSV ниже). В нем первая строка таблицы - техническая, она в выгрузке пропущена. Реальная шапка таблицы начинается со строки №2 документа, в выгрузке CSV это строка с заголовками таблицы.
- Каждый исполнитель заведен в таблицу в виде двух строк:
  -- В первой строке: статус, ФИО, телефон, реквизиты и т.п., а также отработанные часы за каждую дату.
  -- Во второй строке: начисленные и выплаченные средства, а также доп. данные.
- Внизу таблицы - строки итогов.
- Столбцы в середине таблицы вида "1-нояб.", "2-нояб.", "3-нояб." это столбцы соответствующих дат. Если исполнитель работал в этот день - в ячейке этого столбца будет числовое значение, например, "11" (*ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets!*)

### Входящий JSON в n8n из salebot.pro:
{
    "method": "worker.gs.add",
    "client_id": "833573536",
    "full_name": "Пупкин Василий Васильевич",
    "phone": "79957804464",
    "order_id": "833573536-582942145",
    "client_type": "5",
    "group_id": "12334",
    "platform_id": "test_client_online",
    "avito_order_id": "7738113964",
    "avito_order_price": "30004000",
    "avito_order_title": "Грузчик ПРОД склад ЕЖЕДНЕВНО оплата",
    "avito_order_url": "https://avito.ru/1234567",
    "avito_profile": "https://avito.ru/user/dsu123",
    "labels": {
        "1809159": "1: Симпл Внуково",
        "1389135": "2: 25-44",
        "1090393": "2: Муж",
        "1037219": "3: Паспорт",
        "1082258": "4: Узбек",
        "1056095": "5: 5-2"
    },
    "lists": {
        "1056102": "Апрелевка",
        "1815825": "Кокошкино"
    }
}

### Колонки с данными нового исполнителя для вставки в первое пустое место табеля (*Вставляем конкретные данные приведенные в примере!*):
- `№` > пропускаем
- `Статус` пропускаем
- `ФИО` > full_name (пример: "Пупкин Василий Васильевич")
- `Телефон / карта` > phone (пример: "79995554433", БЕЗ нормализации)
- `client_id / comments` > client_id (пример: "12345")
- `Паспорт / ИНН` > пропускаем
- `tags` > labels (пример: "1: Симпл Внуково, 2: 25-44, 2: Муж, 3: Паспорт, 4: Узбек, 5: 5-2")


### Таблица табеля с исполнителями и свободными местами в списке исполнителей (*ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets!*)

```CSV
,,Бау,,,,,,,,,,,,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,,,,,,,,,,
№,Статус,ФИО,Телефон / карта,client_id / comments,Паспорт / ИНН,tags,СБП Телефон,СБП Банк,СБП Получатель,Нач / обед,Окон,Пер,Часов / Ставка,1-нояб.,2-нояб.,3-нояб.,4-нояб.,5-нояб.,6-нояб.,7-нояб.,8-нояб.,9-нояб.,10-нояб.,11-нояб.,12-нояб.,13-нояб.,14-нояб.,15-нояб.,16-нояб.,17-нояб.,18-нояб.,19-нояб.,20-нояб.,21-нояб.,22-нояб.,23-нояб.,24-нояб.,25-нояб.,26-нояб.,27-нояб.,28-нояб.,29-нояб.,30-нояб.,1-дек.,2-дек.,3-дек.,4-дек.,5-дек.,6-дек.,7-дек.,Расчет,Отраб. час / выпл. аванс,ИТОГО к оплате,Деп накоп прош мес дата / руб,Депозит тек мес дата / руб,Деп списан тек мес дата / руб,Деп выпл тек мес дата / руб,"ВнеРеализ, руб",,Комментарий
1,д,Трубский Егор,+7 958 636-46-50,818255659,,21,,,,08:00,17:00,0,9,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,9,В*,В*,В*,В*,В*,В*,Д*,,,,,,,,,,,,,,,,9 ,ВтПт,22-июл.,,,,,,
1,,,Тбанк,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,4 000 р.,0 р.,4 000 р.,,,,0 р.,,
2,д,Вербжицкий Евгений,+7 928 823-69-71,749224881,,27,,,,08:00,17:00,0,9,9,9,9,В,10,9,9,9,9,9,9,10,В,11,10,9,9,В*,9,Д1,Д+,Д*,Д*,,,,,,,,,,,,,,,,149 ,ВтПт,16-сент.,,,,,,
2,,,"8 928 812 86 38 Альфа, Карина Т.",,,,,,,,,,4 000,,,,12 000,,,12 444,,,,16 000,,,8 445,,,,13 333,,,,,,,,,,,,,,,,,,,,,62 222 р.,4 000 р.,4 000 р.,,,,0 р.,,
3,д,Тырышкин Евгений,+7 977 468-79-95,665554095,,30+,,,,08:00,17:00,0,9,9,9,В*,В*,В*,В*,В*,Невых!,В*,В*,В*,В*,В*,В*,В*,В*,В*,9,9,В*,В*,В*,В*,,,,,,,,,,,,,,,,36 ,ВтПт,,,,,,,
3,,,8 961 122 30 25 СБЕР Евгений Сергеевич Т.,,,,,,,,,,4 000,,,,8 000,,,,,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,12 000 р.,4 000 р.,,,,,0 р.,,
,,,,,,,,,,,,,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
24,бан,Кричевцев Александр 48,+7 901 334-30-15,802308131,,48,,,,08:00,17:00,,9,Д+?Ннс!,В,снят,снят,снят,снят,снят,В*,В*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
24,,,8 905 559 88 89 Сбер Светлана Юрьевна В.,,,,,,,,,,4 000,последний шанс,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
25,бан,Кофтун Андрей 39 Домодедово,+7 916 998-58-86,813844649,,,,,,08:00,17:00,,9,,,Невых!,БАН!,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
25,,,МТС Деньги,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
,,,,,,,,,,,,,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
,,Итого отработано часов,,,,,,,,,,,,64,54,67,54,70,65,65,54,56,54,65,52,71,54,20,63,54,63,63,0,0,0,0,0,0,0,0,0,0,0,,,,,,,,,1 108,,,,,,,,
,,"Итого выплачено авансов, руб",,,,,,,,,,,,0 р.,16 444 р.,8 000 р.,70 889 р.,12 000 р.,10 888 р.,69 510 р.,8 000 р.,8 445 р.,24 444 р.,57 734 р.,14 445 р.,10 890 р.,49 245 р.,4 444 р.,8 000 р.,8 000 р.,69 133 р.,12 000 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,,,,,,,,0 р.,462 511 р.,22 179 р.,24 000 р.,8 000 р.,4 000 р.,8 000 р.,8 000 р.,,
,,"Вывод,чел",,,,,,,,,,,,7,6,7,6,7,7,7,6,6,6,7,5,6,5,2,7,6,7,7,0,0,0,0,0,0,0,0,0,0,0,,,,,,,,,"6,16",,,,,,,,
```

## Задача:
Реализовать workflow n8n виде готового JSON файла для импорта:
- Принимает JSON заданной структуры из Salebot.pro .
- Проверяет наличие исполнителя в таблице табеля по столбцу `client_id / comments` и значению client_id=12345.
- Если такой исполнитель уже есть в табеле: обновляет его данные.
- Если такого исполнителя в табеле еще нет:
  - Ищет в таблице Google Sheets первое свободное место из двух строк для вставки данных нового исполнителя. Свободное место - это как-минимум две последовательные строки, у которых ФИО не заполнено. 
  - Вставляет в свободное место в соответствующие столбцы данные нового исполнителя.
- Если свободного места для вставки нет > просто пропустить вставку данных.
- По итогам работы - вернуть соответствующий результат (вставлены данные, пропущены, ошибка и т.п. все основные кейсы).








# 25.11.2025 - ФИЧА: Обработака единичной выплаты по табелю.

## Контекст и описание задачи:
Мне необходимо совершать выплаты средств исполнителям. Для этого у меня есть сервис paybot, который принимает входящую команду через POST, производит выплату исполнителю через интернет-банк и возвращает результат операции в виде json.

Мне необходимо автоматизировать выплаты. Краткий алгоритм:
- Workflow периодически раз в 15 минут просматривает Google Sheets таблицу с Табелем.
- Если в строке начислений по исполнителю в столбце текущей даты находит необработанное начисление в виде простого числа в ячейке (т.е. сумма задается НЕ формулой, а простым числом в ячейке! например "4000" - ок, а "=4000" или ">4000" это НЕ начисление), то проверяет сумму:
  - Если сумма для перевода более 15000 - эту сумму ПРОПУСКАЕМ не трогая. Она НЕ должна попадать под перечисление. Т.е. максимальная сумма к перечислению - 15000 включительно.
  - Если сумма в диапазоне 0-15000, то проверяем, чтобы сумма заканчивалась ровно на 1 копейку (это защита от случайного начисления). Сумма должна быть суммой рублей и дополнительно ровно с 1 копейкой. Т.е. 2000,01р., 3800,01р., 4600,01р. и т.д..
   - Если сумма не имеет ровно 1 копейку на конце - ПРОПУСКАЕТ не трогая. Она НЕ должна попадать под перечисление.
   - Если сумма соответствует шаблону 1 копейки, т.е. имеет на конце ровно 1 копейку - совершает выплату:
    - Сначала сразу во избежание ошибки меняет значение ячейки с числом на знак ">" и это число. Например, было просто число "4000,01", стало ">4000,01". Таким образом, сразу ставится отметка той ячейки, по которой совершается выплата. Это нужно для гарантированного исключения повторного перечисления одной и той же суммы (например, если далее в процессе выполнения будет ошибка). САМАЯ БОЛЬШАЯ КАТАСТРОФА - ЭТО ДВОЙНОЕ ПЕРЕЧИСЛЕНИЕ СРЕДСТВ!!!
    - Передает в сервис paybot запрос POST-json с данными для перечисления (см curl команду ниже).
      - При этом сумму обрабатывает уже БЕЗ этой 1 копейки. Т.е. отбрасывает копейки при обращении к paybot через POST-json.
    - Ожидает выполнения операции (timeout после 60 секунд).
    - Если результат выполнения успешен:
      - Проверяеет значение ячейки - оно должно быть в состоянии начала совершения выплаты. Т.е. если на предыдущем шаге скрипт начал выплату и отметил это в ячейке как ">4000,01" из примера выше, то он ожидает значение в ячейке ">4000,01".
      - Если значение совпадает с ожидаемым - меняет значение ячейки на формулу со знаком равно и числовым значением суммы БЕЗ копейки, т.е. отбрасываем копейку (сумму делаем ровно такой какую отправляли через paybot). Например, было ">4000,01", то после успешного перевода меняем на "=4000". Таким образом, по значению в виде формулы "=4000" мы можем понимать успех перевода.
      - Если значение НЕ совпадает с ожидаемым - меняем значение ячейки на "!>4000,01", т.е. добавляем восклицательный знак в начало содержимого ячейки. Это индикатор ошибки.
    - Если результат выполнения НЕ успешен или таймаут более 60 секунд - меняем значение ячейки на "!>4000", т.е. добавляем восклицательный знак в начало содержимого ячейки. Это индикатор ошибки.
- Если результат платежа успешен - формируем JSON ответ с подробностями операции.
- Если возникла ошибка - формируем JSON ответ с подробностями ошибки.

## Исходные данные:
- Табель выхода исполнителей на работу. В нем ведется начисление средств, а также учет перечисления средств: "Бау - Табель" (структура выгруженная в виде CSV ниже).
  - В нем первая строка таблицы (",,Бау,,,,,,,,,,,,сб,вс,..." и т.д.) - техническая, ее нужно пропустить.
  - Реальная шапка для таблицы с данными начинается со строки №2 документа, где первый столбец в строке №2 это "№", второй "Статус" и т.д..
  - В заголовках таблицы отображение столбцов с датами "1-нояб.", "2-нояб." и т.д. это только отображение при выгрузке в CSV, реальный формат этих заголовков в таблице - это "Дата" в Google Sheets, например, "25.11.2025" - обрабатывать их нужно как дату.
  - Каждый исполнитель заведен в таблицу в виде двух строк:
    - В первой строке: статус, ФИО, телефон, реквизиты и т.п., а также отработанные часы за каждую дату.
    - Во второй строке: начисленные и выплаченные средства, а также доп. данные.
  - Внизу таблицы - есть строки итогов (опущены для краткости).
  - В столбцах с заголовками в виде дат "1-нояб.", "2-нояб.", "3-нояб." указываются данных графика работы или отработанных часов исполнителя за смену по этой дате.
    - Если исполнитель работал в этот день - в ячейке этого столбца будет числовое значение, например, "11".
    - Если у исполнителя выходной в этот день - в ячейке будет "В" или "В*".
  - Также в столбцах с соответствующей датой указывается сумма начисленного вознаграждения исполнителю за смену в этот день.
    - Если исполнителю начислено 4000 рублей за смену в этот день, в ячейке второй строки по исполнителю будет "4000" в виде числа.
    - Если исполнителю начисленные средства уже были выплачены, то в ячейке эта сумма указывается как формула "=4000". Т.е. запись той же суммы не в виде числа, а в виде формулы - это индикатор того, что данные средства были исполнителю выплачены.
    - Если исполнителю средства были выплачены и было отправлено уведомление о том, что средства ему переведены, то в данной ячейке будет формула с окончанием "+0", например "=4000+0". Это индикатор того, что исполнителю было отправлено уведомление о сделанном ему перечислении.


### CSV Таблица табеля с исполнителями, учетом времени, начислений и выплат (*ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets! Также помни про первую техническую строку - реальная шапка таблицы находится в строке №2! Наконец, помни, что каждый исполнитель в табеле - это две соседние строки!*)

```CSV
,,Бау,,,,,,,,,,,,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,,,,,,,,,,,,,
№,Статус,ФИО,Телефон / карта,client_id / comments,Паспорт / ИНН,tags,СБП Телефон,СБП Банк,СБП Получатель,Нач / обед,Окон,Пер,Часов / Ставка,1-нояб.,2-нояб.,3-нояб.,4-нояб.,5-нояб.,6-нояб.,7-нояб.,8-нояб.,9-нояб.,10-нояб.,11-нояб.,12-нояб.,13-нояб.,14-нояб.,15-нояб.,16-нояб.,17-нояб.,18-нояб.,19-нояб.,20-нояб.,21-нояб.,22-нояб.,23-нояб.,24-нояб.,25-нояб.,26-нояб.,27-нояб.,28-нояб.,29-нояб.,30-нояб.,1-дек.,2-дек.,3-дек.,4-дек.,5-дек.,6-дек.,7-дек.,Расчет,Отраб. час / выпл. аванс,ИТОГО к оплате,Деп накоп прош мес дата / руб,Депозит тек мес дата / руб,Деп списан тек мес дата / руб,Деп выпл тек мес дата / руб,"ВнеРеализ, руб",,Комментарий,Выплачено,К выплате,cURL
1,д,Трубский Егор,+7 958 636-46-50,818255659,,21,+7 958 636-46-50,Т-Банк,Егор Павлович Т.,08:00,17:00,0,9,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,9,В*,В*,В*,В*,В*,В*,9,В*,В*,В*,В*,В*,В*,Д*,,,,,,,,,18 ,ВтПт,22-июл.,,,,,,,,,
1,,,Тбанк,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,4 000,,,,,,,4 000,,,,,,,,,,,,,,8 000 р.,0 р.,4 000 р.,,,,0 р.,,,4 000,4 000,"curl -X POST ""http://localhost:8787/api/alfa/pay"" -H ""Content-Type: application/json"" -H ""X-Auth-Token: my-secret-token"" -d '{""source_account"": ""Наши авансы"", ""phone"": ""79586364650"", ""bank"": ""Т-Банк"", ""recipient_name"": ""Егор Павлович Т."", ""amount"": ""4000""}'"
2,д,Вербжицкий Евгений,+7 928 823-69-71,749224881,,27,+7 928 812-86-38,Альфа-Банк,Каринэ Альбертовна Т.,08:00,17:00,0,9,9,9,9,В,10,9,9,9,9,9,9,10,В,11,10,9,9,В*,9,9,9,9,9,9,Д1,Д+,Д*,Д*,Д*,Д*,,,,,,,,,194 ,ВтПт,16-сент.,,,,,,,,,
2,,,<СБП реквизиты>,,,,,,,,,,4 000,,,,12 000,,,12 444,,,,16 000,,,8 445,,,,13 333,,,12 000,,,,16 000,,,,,,,,,,,,,,90 222 р.,-4 000 р.,4 000 р.,,,,0 р.,,,74 222,16 000,
```

## Примеры cURL запросов к сервису paybot и ответы:

### Параметры cURL:
- "http://localhost:8787/api/alfa/pay" - адрес paybot метода (константа Config).
- "X-Auth-Token: my-secret-token" - токен доступа к методу paybot (константа Config).
- "source_account": "Наши авансы" - счет источник платежа (константа Config).
- "phone": "79033699785" - значение ячейки столбца "СБП Телефон".
- "bank": "Сбербанк" - значение ячейки столбца "СБП Банк".
- "recipient_name": "Шарифхон О." - значение ячейки столбца "СБП Получатель".
- "amount": "4400" - значение ячейки с суммой в столбце с соответствующей датой, по которой инициирован платеж (уже с отброшенной копейкой в конце).

### Успешный запрос на выплату ("ok": true):
```bash
dkny@LENOVOE15:~/projects/paybot$ curl -X POST "http://localhost:8787/api/alfa/pay" -H "Content-Type: application/json" -H "X-Auth-Token: my-secret-token" -d '{"source_account": "Наши авансы", "phone": "79033699785", "bank": "Сбербанк", "recipient_name": "Шарифхон О.", "amount": "4400"}'
{"ok": true, "message": "Перевод выполнен\nСчёт списания ··3967\n25 133,25 ₽ → 20 733,25 ₽\n−4 400 ₽\nБез комиссии\nШарифхон О.\nВ Сбербанк через СБП п", "amount": "4400", "phone": "79033699785", "recipient_name": "Шарифхон О.", "recipient_bank": "Сбербанк", "source_account": "Наши авансы", "trace_path": "./traces/alfa/alfa_manual_transfer_7964_20251124_141418.zip", "screenshot_path": "./traces/alfa/alfa_manual_transfer_7964_20251124_141418_final.png"}
```
### Неуспешный запрос на выплату ("ok": false) - отсутствует параметр:
```bash
dkny@LENOVOE15:~/projects/n8n$ curl -X POST "http://localhost:8787/api/alfa/pay" -H "Content-Type: application/json" -H "X-Auth-Token: my-secret-token" -d '{"source_account": "Наши авансы", "phone": "", "bank": "", "recipient_name": "", "amount": "4000"}'
{"ok": false, "error_code": "bad_request", "message": "Missing or empty fields: phone, bank, recipient_name"}
```
### Неуспешный запрос на выплату ("ok": false) - ошибка валидации имени:
```bash
dkny@LENOVOE15:~$ curl -X POST "http://localhost:8787/api/alfa/pay" -H "Content-Type: application/json" -H "X-Auth-Token: my-secret-token" -d '{"source_account": "Наши авансы", "phone": "79779049611", "bank": "КБ Солидарность", "recipient_name": "Хошимов", "amount": "4400"}'
{"ok": false, "error_code": "payment_failed", "message": "Ошибки валидации: recipient: ожидалось точное имя 'Хошимов'", "amount": "4400", "phone": "79779049611", "recipient_name": "Хошимов", "recipient_bank": "КБ Солидарность", "source_account": "Наши авансы", "trace_path": "./traces/alfa/alfa_manual_transfer_7964_20251120_101631.zip", "screenshot_path": "./traces/alfa/alfa_manual_transfer_7964_20251120_101631_final.png"}
```

# Инструкции
- Максимум функциональности делай в нодах вида Code с использованием JavaScript. Чтобы потом можно было манипулировать данными через код. Т.е. старайся добавлять меньше ветвлений и нод других типов.
- Выноси константы и настроечные переменные в ноду `Config`.
- При работе с Google Sheets для обновления данных делай точечные изменения данных в конкретных столбцах/ячейках, а не всей строки сразу. Мне НЕ НУЖНО иметь гарантию целостности строки. Мне нужно видеть чистую историю обновлений в GUI для каждой ячейки таблицы в отдельности.
  * Название месяца листа в Google Sheets с которым работаем - определяем в коде, не нужно это делать в настройках. Если не задана конкретная дата для обработки, то делаем fallback подразумевая текущую дату и соответствующий текущий месяц. Например: если дата не задана как параметр и сегодня "22.11.2025" - то работаем с листом "нояб_25".

## Задача:
Реализовать workflow n8n виде готового JSON файла для импорта:
1. САМАЯ БОЛЬШАЯ КАТАСТРОФА - ЭТО ДВОЙНОЕ ПЕРЕЧИСЛЕНИЕ СРЕДСТВ!!!
2. ВСЕ ОПЕРАЦИИ СОВЕРШАЮТСЯ ОДИН РАЗ - ПРИ ВОЗНИКНОВЕНИИ ЛЮБОЙ ОШИБКИ ПРОПУСКАЕМ ПЕРЕЧИСЛЕНИЕ!!! (все ошибки обрабатываются вручную оператором и платеж не должен попадать в повторное перечисление без яного исправления ошибки)

# Ожидаемый результат:
- Готовый к импорту в n8n новый workflow в формате JSON (верни код полностью).
- Описание логики работы workflow по шагам каждой ноды с объяснением почему сделано именно так.

## Итог реализации:

### Создан workflow: `payment.single.json`
**Путь**: `/n8n.workflow.json/payment.single.json`

### Триггер
- Schedule Trigger: каждые 15 минут

### Алгоритм работы
1. **Config** — константы: timesheetId, paybotUrl, paybotToken, sourceAccount, maxAmount=15000
2. **Prepare Sheet Name** — определяет лист по текущей дате (формат `нояб_25`)
3. **Read Timesheet** — читает табель (headerRow=2, firstDataRow=3)
4. **Find Payment** — ищет ОДИН подходящий платёж:
   - Только вторые строки блоков (строки начислений)
   - Сумма ≤ 15000 и заканчивается на `.01` (1 копейка)
   - У исполнителя заполнены СБП реквизиты (Телефон, Банк, Получатель)
   - Возвращает диагностику пропущенных платежей в `skippedPayments`
5. **Switch Payment** — ветвление: найден платёж / нет платежей
6. **Prepare Mark Start** — формирует объект с динамической колонкой даты
7. **Mark Cell Start** — КРИТИЧНО: помечает ячейку `>СУММА` ДО платежа (защита от двойного перечисления)
8. **HTTP Paybot** — POST к paybot (timeout 60 сек), onError: continueErrorOutput
9. **Process Result** — определяет финальное значение: `=СУММА` (успех) или `!>СУММА` (ошибка)
10. **Update Cell Final** — записывает финальный статус в ячейку
11. **Handle Mark Error** — если ошибка пометки ячейки: платёж НЕ отправляется

### Форматы значений ячейки суммы
| Значение | Статус |
|----------|--------|
| `4000,01` | Готов к выплате |
| `>4000,01` | Платёж в процессе |
| `=4000` | Выплачено |
| `!>4000,01` | Ошибка |

### Защитные механизмы
- **Один платёж за запуск** — обрабатывается только первый найденный
- **Маркер ">" ДО платежа** — гарантирует невозможность двойного перечисления
- **Fail-safe** — при ЛЮБОЙ ошибке платёж пропускается, ячейка помечается `!`
- **Валидация суммы** — только числа с `.01` копейкой и ≤ 15000

### Требования к данным исполнителя
Для успешного платежа в первой строке блока исполнителя должны быть заполнены:
- `СБП Телефон`
- `СБП Банк`
- `СБП Получатель`






# 28.11.2025 - ФИЧА: разделение workflow payment.single.json на суб workflow payment.single.alfa.json.

## Бизнес потребность:
- Сейчас workflow @n8n.prod.workflow/payment.single.json выполняет и чтение табеля и запуск-ожидание совершение перевода. Я хочу разделить его на две части:
  - "Оркестратор", т.е. workflow верхнего уровня, которое читает табель и определяет есть ли в нем платежи к перечислению. payment.single.json.
  - "Исполнитель", т.е. workflow которое получит данные для совершения единичного платежа и выполнит его: payment.single.alfa.json.

В workflow @n8n.prod.workflow/payment.single.json есть нода `HTTP Paybot` которая выполняет единичный запрос и перевод через сервис paybot. Я хотел бы сделать его в виде подчиненного workflow payment.single.alfa.json. В последствии к payment.single.alfa.json добавится payment.single.tbank.json и добавится логика в "оркестраторе" payment.single.json.

## Исходные данные:
- workflow @n8n.prod.workflow/payment.single.json.
- URL подчиненнго webhook: /payment/single/alfa/

## Задача:
- Сформировать payment.single.json вызывающий по http request подчиненный воркфлоу payment.single.alfa.json.
- При этом "оркестратор" сразу отмечает в ячейке начало работы с переводом! (т.е. ставит ">%сумма_в_ячейке%" и затем вызывает подчиненный workflow).
- Вызовы всегда делаем через HTTP request, используем при вызове и при запуске подчиненных воркфлоу существующую авторизацию Header Auth `router - Header Auth account` ("x-api-key": "%x-api-key-value%").

## Ожидаемый результат:
- Два JSON файла, один главный запускается как сейчас и вызывает подчиненный подпроцесс.
- Описание и обоснование сделнных изменений.

## Итог реализации:

### Созданы два workflow:

**payment.single.json (Оркестратор):**
- Читает табель, ищет платёж, помечает ячейку `>сумма` ДО вызова исполнителя
- Вызывает sub-workflow через `HTTP Sub-Workflow Alfa` → `POST /payment/single/alfa/`
- Обрабатывает ответ и обновляет ячейку: `=сумма` (успех) или `!>сумма` (ошибка)
- Credential: `router - Header Auth account`
- Config: добавлен `webhookBaseUrl: https://n8n.autsorsim.ru/webhook/`

**payment.single.alfa.json (Исполнитель):**
- Webhook POST `/payment/single/alfa/` с авторизацией `router - Header Auth account`
- Принимает: `{phone, bank, recipient_name, amount, source_account}`
- Вызывает paybot напрямую (credential: `paybot - Header Auth account`)
- Возвращает: `{ok: true/false, message, paybotResponse}`

### Принцип разделения:
- Оркестратор контролирует состояние ячейки (защита от двойного перечисления)
- Исполнитель — чистая функция: получил данные → выполнил платёж → вернул результат
- Подготовлено для добавления `payment.single.tbank.json` с аналогичным интерфейсом






# 28.11.2025 - ФИЧА: Обработка нескольких платежей в одном табеле.

## Бизнес потребность:
- Сейчас мы обрабатываем только один первый платеж в каждом табеле. Необходимо обрабатывать все найденные платежи последовательно, друг за другом: нашли трех исполнителей подходящих под переводы > три раза запускаем подпроцесс перевода.
- При первой же ошибке при перечислениях останавливаем ВЕСЬ процесс полностью! Т.е. НЕ продолжаем следующим исполнителем, а останавливаем полность!
- Результат выполнения может занимать длительное время (если исполнителей несколько, а на каждого из них тратится примерно 30 секунд).
- Если исполнитель не подпадает под перечисление, например, сумма больше лимита 15000,01р - это не является ошибкой, поэтому процесс не должен останавливаться на этом месте.
- Сначала определяем всех исполнителей подпадающих под перечисление и затем для каждого из них делаем перечисление подпроцессом. И вот если в этот момент возникает любая ошибка - останавливаем перечисления для всех исполнителей и завершаем процесс с возвратом сообщения об ошибке!

## Исходные данные:
- Файлы workflow: n8n.prod.workflow/payment.single.json и n8n.prod.workflow/payment.single.alfa.json.

## ЗАДАЧА:
- Изменить процесс оркестратора payment.single.json таким образом, чтобы подпроцесс перечисления вызывался столько раз, сколько найдено исполнителей в табеле подпадающих под условия перечисления.

## Ожидаемый результат:
- После запуска workflow перечисления будут сделаны всем подпадающим под критерии исполнителям.

## Итог реализации:

### Обновлён workflow: `payment.single.json`
**Путь**: `/n8n.prod.workflow/payment.single.json`

### Ключевые изменения

1. **Find Payment → Find All Payments**
   - Теперь возвращает массив ВСЕХ подходящих платежей вместо первого найденного
   - Каждый платёж содержит `paymentIndex` и `totalPayments` для отслеживания

2. **Добавлен Loop Over Payments (SplitInBatches)**
   - `batchSize=1` для последовательной обработки платежей
   - Каждый платёж обрабатывается полностью перед переходом к следующему

3. **Добавлен Switch Result для остановки при ошибке**
   - `Success` → возврат к Loop для следующего платежа
   - `Error` → выход из цикла в Aggregate Results

4. **Добавлен Store Result + Aggregate Results**
   - Результаты каждого платежа сохраняются в `$getWorkflowStaticData('global')`
   - В конце формируется агрегированный результат со статистикой

### Схема workflow

```
Manual Trigger → Config → Prepare Sheet Name → Read Timesheet
→ Find All Payments → Switch Has Payments
   ├─ No Payments → Result No Payment
   └─ Has Payments → Init Processing → Loop Over Payments
         ├─ [item] → Prepare Mark Start → Mark Cell Start
         │    ├─ [ok] → HTTP Sub-Workflow Alfa → Process Result
         │    │         → Update Cell Final → Store Result → Switch Result
         │    │              ├─ [Success] → Loop Over Payments (next)
         │    │              └─ [Error] → Aggregate Results (stop)
         │    └─ [error] → Handle Mark Error → Aggregate Results (stop)
         └─ [done] → Aggregate Results
```

### Формат финального результата

```json
{
  "status": "completed" | "error" | "no_payment",
  "message": "Все платежи успешно обработаны: 3 из 3",
  "processed": 3,
  "successful": 3,
  "failed": 0,
  "payments": [
    {
      "paymentIndex": 0,
      "workerName": "Иванов Иван",
      "amount": 4000,
      "status": "success",
      "message": "Платёж выполнен успешно",
      ...
    },
    ...
  ]
}
```

### Защитные механизмы (сохранены)

- **Маркер `>` ДО платежа** — ставится перед каждым вызовом sub-workflow
- **Остановка при первой ошибке** — необработанные платежи остаются нетронутыми
- **Валидация суммы** — только числа с `.01` копейкой и ≤ 15000,01

