# КОНТЕКСТ:
Вся реализованная инфа перенесена в @n8n_featured.md. Здесь только TODO.



# ФИЧА 18.11.2025 - Вставка данных исполнителя в табель

## Контекст
Мне необходимо сохранять данные об исполнителе из чат-бот-платформы SaleBot.pro в Google Sheets через Workflow в N8n.

мне необходимо написать такой workflow который будет делать следующую логику один по входящему запросу из salebot он принимает json структуры которые описаны ниже в этом джейсоне находятся данные о авито-объявлении на которое откликнулся человек а также метки из crm системы часть из которых соответствует проектам на который откликнулся этот исполнитель таким образом во входящем json у нас будет avito_order_id как идентификатор того объявления а значит и проекта на которой откликнулся исполнитель и массив меток labels среди которых есть метки с шаблоном "1: %название_проекта%", т.е. шаблон начинается как цифра "1" затем двоеточие и  пробел ": " и далее название проекта на который откликается этот исполнитель.

Эти данные нам необходимо далее искать в Google таблице на листе справочники. Найти по названию одного или нескольких полученных из JSON названий проектов. Найти соответствующие этим проектам идентификаторы Google Sheet таблицы в столбце `Табель`. Структура листа "Справочники" ниже.

После того, как мы получили идентификатор Google Таблицы, мы должны добавить новую запись об исполнителе в файл табель этого проекта (образец структуры табеля ниже). Мы добавим исполнителя в пустую строчку. При этом мы добавляем исполнителя если такого еще в этом файле нет. Соответствие и проверку исполнителей делаем по client_id. Если такой client_id уже нет в файле есть то обновляем данные. Если такого client_id еще в файле нет то добавляем новую строку.


И после этой строки мы должны оставлять пустую строку, которая нужна как разделитель, а также для других данных с другим функционалом. Т.е. каждая запись об исполнителе - это ДВЕ строки. Одна с данными исполнителя, вторая с доп. данными.

Пуструю строку мы определяем как пустое значение в ячейке "ФИО", т.е. проверяя сверху вниз мы смотрим первое место где ФИО пусто, отступаем одну строку ниже (т.к. нам всегда нужно оставлять после ФИО одну строку для доп данных) и вставляем новые данные в это место.

Если такой исполнитель уже есть в файле, то работаем с той строчкой, где уже есть client_id.

## Соответствие данных json и столбцам в google sheet (т.е. вставляем только эти данные!):
- № пропускаем
- Статаус пропускаем
- ФИО > full_name
- Телефон / карта > phone
- client_id / comments > client_id
- Паспорт / ИНН > пропускаем
- tags > labels (но очищенный, без id и просто в строку через запятую, пример: "1: Симпл Внуково, 2: 25-44, 2: Муж, 3: Паспорт, 4: Узбек, 5: 5-2")

## Исходные данные:

### Входящий JSON в n8n из salebot.pro:

{
    "method": "worker.gs.add",
    "client_id": "833573536",
    "full_name": "Пупкин Василий Васильевич",
    "phone": "79957804464",
    "order_id": "833573536-582942145",
    "client_type": "5",
    "group_id": "12334",
    "platform_id": "test_client_online",
    "avito_order_id": "7738113964",
    "avito_order_price": "30004000",
    "avito_order_title": "Грузчик ПРОД склад ЕЖЕДНЕВНО оплата",
    "avito_order_url": "https://avito.ru/1234567",
    "avito_profile": "https://avito.ru/user/dsu123",
    "labels": {
        "1809159": "1: Симпл Внуково",
        "1389135": "2: 25-44",
        "1090393": "2: Муж",
        "1037219": "3: Паспорт",
        "1082258": "4: Узбек",
        "1056095": "5: 5-2"
    },
    "lists": {
        "1056102": "Апрелевка",
        "1815825": "Кокошкино"
    }
}

### Таблица Google Sheet 1yYSPC2JVTV5a6Byoz8lO4GsrD-Nk6i8PCF68hn_7f4I (файл `Объявления`, лист `Справочники`:
Проекты,,Табель,,Специализация,,Тип объекта,,Частота сверок и оплат,,Время заведения на объект - День,,Время заведения на объект - Ночь,,Гражданство,,Города
_ПРОД Склад,,,,_Любая специализация,,_Шаблон,,"Сверка 1 раз в месяц, оплата 1 раз в месяц",,В тот же день (любой день),,В тот же вечер (любой день),,ЕАЭС,,Апрелевка


### Таблица Google Sheet 1yYSPC2JVTV5a6Byoz8lO4GsrD-Nk6i8PCF68hn_7f4I (файл `Объявления`, лист `Avito`:
AvitoID,Проект,Специализация,Статус,Адрес,Комментарий
7738426189,Бау,Разнорабочий,Активно,"Московская обл., г.о. Подольск, д. Макарово, Луговая ул., 26Г",

### Шаблоны соответствия листа в табеле от текущего месяца (код из php):
        1 => 'янв', 2 => 'фев', 3 => 'мар', 4 => 'апр', 5 => 'май', 6 => 'июнь',
        7 => 'июль',8 => 'авг', 9 => 'сен',10 => 'окт',11 => 'нояб',12 => 'дек'

### Таблица табеля с исполнителями (ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets!):
№,Статус,ФИО,Телефон / карта,client_id / comments,Паспорт / ИНН,tags,Нач / обед,Окон,Пер,Часов / Ставка,1-нояб.,2-нояб.,3-нояб.,4-нояб.,5-нояб.,6-нояб.,7-нояб.,8-нояб.,9-нояб.,10-нояб.,11-нояб.,12-нояб.,13-нояб.,14-нояб.,15-нояб.,16-нояб.,17-нояб.,18-нояб.,19-нояб.,20-нояб.,21-нояб.,22-нояб.,23-нояб.,24-нояб.,25-нояб.,26-нояб.,27-нояб.,28-нояб.,29-нояб.,30-нояб.,1-дек.,2-дек.,3-дек.,4-дек.,5-дек.,6-дек.,7-дек.,Расчет,Отраб. час / выпл. аванс,ИТОГО к оплате,Деп накоп прош мес дата / руб,Депозит тек мес дата / руб,Деп списан тек мес дата / руб,Деп выпл тек мес дата / руб,"ВнеРеализ, руб",,Комментарий
1,д,Трубский Егор,+7 958 636-46-50,818255659,,21,08:00,17:00,0,9,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,Д1,В*,В*,В*,В*,В*,В*,Д*,,,,,,,,,,,,,,,,0 ,ВтПт,22-июл.,,,,,,
1,,,Тбанк,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,4 000 р.,,,,0 р.,,


## Задача:
- Реализовать такой workflow для n8n. Использовать MCP.
- Помнить, что это MVP и решение должно быть простым и эффективным.






# 20.11.2025 - ФИЧА: Поиск свободного места в табеле и вставка данных.

## Исходные данные:
- Есть табель выхода исполнителей на работу и перечисления им средств "Бау - Табель" (структура выгруженная в виде CSV ниже). В нем первая строка таблицы - техническая, она в выгрузке пропущена. Реальная шапка таблицы начинается со строки №2 документа, в выгрузке CSV это строка с заголовками таблицы.
- Каждый исполнитель заведен в таблицу в виде двух строк:
  -- В первой строке: статус, ФИО, телефон, реквизиты и т.п., а также отработанные часы за каждую дату.
  -- Во второй строке: начисленные и выплаченные средства, а также доп. данные.
- Внизу таблицы - строки итогов.
- Столбцы в середине таблицы вида "1-нояб.", "2-нояб.", "3-нояб." это столбцы соответствующих дат. Если исполнитель работал в этот день - в ячейке этого столбца будет числовое значение, например, "11" (*ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets!*)

### Входящий JSON в n8n из salebot.pro:
{
    "method": "worker.gs.add",
    "client_id": "833573536",
    "full_name": "Пупкин Василий Васильевич",
    "phone": "79957804464",
    "order_id": "833573536-582942145",
    "client_type": "5",
    "group_id": "12334",
    "platform_id": "test_client_online",
    "avito_order_id": "7738113964",
    "avito_order_price": "30004000",
    "avito_order_title": "Грузчик ПРОД склад ЕЖЕДНЕВНО оплата",
    "avito_order_url": "https://avito.ru/1234567",
    "avito_profile": "https://avito.ru/user/dsu123",
    "labels": {
        "1809159": "1: Симпл Внуково",
        "1389135": "2: 25-44",
        "1090393": "2: Муж",
        "1037219": "3: Паспорт",
        "1082258": "4: Узбек",
        "1056095": "5: 5-2"
    },
    "lists": {
        "1056102": "Апрелевка",
        "1815825": "Кокошкино"
    }
}

### Колонки с данными нового исполнителя для вставки в первое пустое место табеля (*Вставляем конкретные данные приведенные в примере!*):
- `№` > пропускаем
- `Статус` пропускаем
- `ФИО` > full_name (пример: "Пупкин Василий Васильевич")
- `Телефон / карта` > phone (пример: "79995554433", БЕЗ нормализации)
- `client_id / comments` > client_id (пример: "12345")
- `Паспорт / ИНН` > пропускаем
- `tags` > labels (пример: "1: Симпл Внуково, 2: 25-44, 2: Муж, 3: Паспорт, 4: Узбек, 5: 5-2")


### Таблица табеля с исполнителями и свободными местами в списке исполнителей (*ВНИМАНИЕ! дата указанная как "1-нояб." - это только формат отображения для CSV! В реальном документе это обычная дата Sheets!*)

```CSV
,,Бау,,,,,,,,,,,,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,пн,вт,ср,чт,пт,сб,вс,,,,,,,,,,
№,Статус,ФИО,Телефон / карта,client_id / comments,Паспорт / ИНН,tags,СБП Телефон,СБП Банк,СБП Получатель,Нач / обед,Окон,Пер,Часов / Ставка,1-нояб.,2-нояб.,3-нояб.,4-нояб.,5-нояб.,6-нояб.,7-нояб.,8-нояб.,9-нояб.,10-нояб.,11-нояб.,12-нояб.,13-нояб.,14-нояб.,15-нояб.,16-нояб.,17-нояб.,18-нояб.,19-нояб.,20-нояб.,21-нояб.,22-нояб.,23-нояб.,24-нояб.,25-нояб.,26-нояб.,27-нояб.,28-нояб.,29-нояб.,30-нояб.,1-дек.,2-дек.,3-дек.,4-дек.,5-дек.,6-дек.,7-дек.,Расчет,Отраб. час / выпл. аванс,ИТОГО к оплате,Деп накоп прош мес дата / руб,Депозит тек мес дата / руб,Деп списан тек мес дата / руб,Деп выпл тек мес дата / руб,"ВнеРеализ, руб",,Комментарий
1,д,Трубский Егор,+7 958 636-46-50,818255659,,21,,,,08:00,17:00,0,9,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,В*,9,В*,В*,В*,В*,В*,В*,Д*,,,,,,,,,,,,,,,,9 ,ВтПт,22-июл.,,,,,,
1,,,Тбанк,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,4 000 р.,0 р.,4 000 р.,,,,0 р.,,
2,д,Вербжицкий Евгений,+7 928 823-69-71,749224881,,27,,,,08:00,17:00,0,9,9,9,9,В,10,9,9,9,9,9,9,10,В,11,10,9,9,В*,9,Д1,Д+,Д*,Д*,,,,,,,,,,,,,,,,149 ,ВтПт,16-сент.,,,,,,
2,,,"8 928 812 86 38 Альфа, Карина Т.",,,,,,,,,,4 000,,,,12 000,,,12 444,,,,16 000,,,8 445,,,,13 333,,,,,,,,,,,,,,,,,,,,,62 222 р.,4 000 р.,4 000 р.,,,,0 р.,,
3,д,Тырышкин Евгений,+7 977 468-79-95,665554095,,30+,,,,08:00,17:00,0,9,9,9,В*,В*,В*,В*,В*,Невых!,В*,В*,В*,В*,В*,В*,В*,В*,В*,9,9,В*,В*,В*,В*,,,,,,,,,,,,,,,,36 ,ВтПт,,,,,,,
3,,,8 961 122 30 25 СБЕР Евгений Сергеевич Т.,,,,,,,,,,4 000,,,,8 000,,,,,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,12 000 р.,4 000 р.,,,,,0 р.,,
,,,,,,,,,,,,,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
24,бан,Кричевцев Александр 48,+7 901 334-30-15,802308131,,48,,,,08:00,17:00,,9,Д+?Ннс!,В,снят,снят,снят,снят,снят,В*,В*,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
24,,,8 905 559 88 89 Сбер Светлана Юрьевна В.,,,,,,,,,,4 000,последний шанс,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
25,бан,Кофтун Андрей 39 Домодедово,+7 916 998-58-86,813844649,,,,,,08:00,17:00,,9,,,Невых!,БАН!,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
25,,,МТС Деньги,,,,,,,,,,4 000,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
,,,,,,,,,,,,,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 ,,,,,,,,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0 р.,0 р.,,,,,0 р.,,
,,Итого отработано часов,,,,,,,,,,,,64,54,67,54,70,65,65,54,56,54,65,52,71,54,20,63,54,63,63,0,0,0,0,0,0,0,0,0,0,0,,,,,,,,,1 108,,,,,,,,
,,"Итого выплачено авансов, руб",,,,,,,,,,,,0 р.,16 444 р.,8 000 р.,70 889 р.,12 000 р.,10 888 р.,69 510 р.,8 000 р.,8 445 р.,24 444 р.,57 734 р.,14 445 р.,10 890 р.,49 245 р.,4 444 р.,8 000 р.,8 000 р.,69 133 р.,12 000 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,0 р.,,,,,,,,0 р.,462 511 р.,22 179 р.,24 000 р.,8 000 р.,4 000 р.,8 000 р.,8 000 р.,,
,,"Вывод,чел",,,,,,,,,,,,7,6,7,6,7,7,7,6,6,6,7,5,6,5,2,7,6,7,7,0,0,0,0,0,0,0,0,0,0,0,,,,,,,,,"6,16",,,,,,,,
```

## Задача:
Реализовать workflow n8n виде готового JSON файла для импорта:
- Принимает JSON заданной структуры из Salebot.pro .
- Проверяет наличие исполнителя в таблице табеля по столбцу `client_id / comments` и значению client_id=12345.
- Если такой исполнитель уже есть в табеле: обновляет его данные.
- Если такого исполнителя в табеле еще нет:
  - Ищет в таблице Google Sheets первое свободное место из двух строк для вставки данных нового исполнителя. Свободное место - это как-минимум две последовательные строки, у которых ФИО не заполнено. 
  - Вставляет в свободное место в соответствующие столбцы данные нового исполнителя.
- Если свободного места для вставки нет > просто пропустить вставку данных.
- По итогам работы - вернуть соответствующий результат (вставлены данные, пропущены, ошибка и т.п. все основные кейсы).




